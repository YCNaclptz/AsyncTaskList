@{
    ViewData["Title"] = "Multi-Task Progress";
}

<div class="text-center mt-5">
    <h1 class="display-4">Task Execution Demo</h1>
    <p class="lead">Click the button below to start the asynchronous tasks and view their progress in real-time.</p>
    
    <button id="btnStart" type="button" class="btn btn-primary btn-lg">
        Start Tasks
    </button>
</div>

<!-- Modal -->
<div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="resultModalLabel">Execution Progress</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="btnCloseHeader" disabled></button>
      </div>
      <div class="modal-body">
        
        <div class="mb-3">
            <label class="form-label">Total Progress</label>
            <div class="progress" style="height: 25px;">
              <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
        </div>

        <ul class="list-group" id="resultList">
          <li class="list-group-item d-flex justify-content-between align-items-center" id="Job Initialization">
            Task 1: Database Insert (5s)
            <span class="badge bg-secondary status-badge">Pending</span>
          </li>
          <li class="list-group-item d-flex justify-content-between align-items-center" id="Business Logic">
            Task 2: Processing (2s)
            <span class="badge bg-secondary status-badge">Pending</span>
          </li>
          <li class="list-group-item d-flex justify-content-between align-items-center" id="External API Call">
            Task 3: Validation (3s - Fails)
            <span class="badge bg-secondary status-badge">Pending</span>
          </li>
          <li class="list-group-item d-flex justify-content-between align-items-center" id="Report Generation">
            Task 4: Cleanup (2s)
            <span class="badge bg-secondary status-badge">Pending</span>
          </li>
        </ul>

        <div id="errorMessage" class="alert alert-danger mt-3 d-none" role="alert">
            An error occurred while communicating with the server.
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="btnCloseFooter" disabled>Close</button>
      </div>
    </div>
  </div>
</div>

<script>
    document.getElementById("btnStart").addEventListener("click", function () {
        const url = "/Home/ExecuteTasks";
        const totalTasks = 4;
        let completedTasks = 0;
        let isAnyTaskFailed = false;

        // UI Initialization
        const modalElement = document.getElementById("resultModal");
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
        
        const progressBar = document.getElementById("progressBar");
        const resultList = document.getElementById("resultList");
        const btnCloseHeader = document.getElementById("btnCloseHeader");
        const btnCloseFooter = document.getElementById("btnCloseFooter");
        const errorMessage = document.getElementById("errorMessage");

        // Reset UI
        progressBar.style.width = "0%";
        progressBar.innerText = "0%";
        progressBar.classList.add("progress-bar-animated");
        progressBar.classList.remove("bg-success", "bg-danger");
        
        btnCloseHeader.disabled = true;
        btnCloseFooter.disabled = true;
        errorMessage.classList.add("d-none");

        document.querySelectorAll('.status-badge').forEach(badge => {
            badge.className = 'badge bg-secondary status-badge';
            badge.innerText = 'Pending';
        });

        fetch(url)
            .then(async response => {
                if (!response.ok) throw new Error("Network response was not ok");

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                let buffer = "";
                let braceCount = 0;
                let objectStartIndex = -1;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) {
                        // The stream has finished. Any remaining content in the buffer
                        // is unlikely to be a complete object if the stream was well-formed,
                        // but we'll log it for debugging.
                        if (buffer.trim().length > 0) {
                            console.warn("Stream finished with incomplete data in buffer:", buffer);
                        }
                        break; // Exit the loop
                    }

                    buffer += decoder.decode(value, { stream: true });

                    // Scan the buffer for complete JSON objects
                    let scanIndex = 0;
                    while (scanIndex < buffer.length) {
                        const char = buffer[scanIndex];

                        if (char === '{') {
                            if (braceCount === 0) {
                                objectStartIndex = scanIndex;
                            }
                            braceCount++;
                        } else if (char === '}') {
                            braceCount--;
                            if (braceCount === 0 && objectStartIndex !== -1) {
                                // Found a complete JSON object from { to }
                                const objectString = buffer.substring(objectStartIndex, scanIndex + 1);
                                
                                try {
                                    const result = JSON.parse(objectString);
                                    updateTaskStatus(result);
                                } catch (e) {
                                    // This can happen if the text between {} is not valid JSON.
                                    // We'll log it but continue processing.
                                    console.error("Failed to parse object string:", e, "String:", objectString);
                                }
                                
                                // Reset for the next potential object
                                objectStartIndex = -1;
                            }
                        }
                        scanIndex++;
                    }

                    // Clean up the buffer by removing the text that has been fully scanned.
                    // If an object is still open, we keep it and the scanner will resume on the next chunk.
                    if (objectStartIndex !== -1) {
                        buffer = buffer.substring(objectStartIndex);
                    } else {
                        buffer = ""; // All scanned text was processed
                    }
                }

                finishProgress();
            })
            .catch(error => {
                console.error('Fetch error:', error);
                errorMessage.classList.remove("d-none");
                errorMessage.innerText = "Error: " + error.message;
                progressBar.classList.remove("progress-bar-animated");
                progressBar.classList.add("bg-danger");
                enableCloseButtons();
            });

        function updateTaskStatus(result) {
            completedTasks++;
            const progress = (completedTasks / totalTasks) * 100;
            progressBar.style.width = progress + "%";
            progressBar.innerText = Math.round(progress) + "%";

            const listItem = document.getElementById(result.message);
            if (listItem) {
                const badge = listItem.querySelector('.status-badge');
                if (result.isSuccess) {
                    badge.className = 'badge bg-success status-badge';
                    badge.innerText = 'Success';
                } else {
                    badge.className = 'badge bg-danger status-badge';
                    badge.innerText = 'Failed';
                    isAnyTaskFailed = true; // Mark that at least one task has failed
                }
            }
        }
        
        function finishProgress() {
            progressBar.classList.remove("progress-bar-animated");
            if (isAnyTaskFailed) {
                progressBar.classList.add("bg-danger");
            } else {
                progressBar.classList.add("bg-success");
            }
            enableCloseButtons();
        }

        function enableCloseButtons() {
            btnCloseHeader.disabled = false;
            btnCloseFooter.disabled = false;
        }
    });
</script>
